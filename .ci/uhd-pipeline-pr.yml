#
# Copyright 2021 Ettus Research, a National Instruments Brand
#
# SPDX-License-Identifier: LGPL-3.0-or-later
#

parameters:
- name: build_linux
  displayName: Build Linux
  type: string
  default: Auto-detect
  values:
  - Auto-detect
  - Force-yes
  - No
- name: build_mac
  displayName: Build macOS
  type: string
  default: Auto-detect
  values:
  - Auto-detect
  - Force-yes
  - No
- name: build_win
  displayName: Build Windows
  type: string
  default: Auto-detect
  values:
  - Auto-detect
  - Force-yes
  - No
- name: custom_boost_version
  type: boolean
  displayName: Use custom boost version
  default: false
- name: custom_boost_version_url
  type: string
  displayName: Custom Boost URL
  default: 'https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2'
- name: release_binaries
  type: boolean
  displayName: Set release mode for installers
  default: false
- name: testLength
  type: string
  values:
  - 'smoke'
  - 'full'
  - 'stress'
  displayName: Test Length
  default: 'smoke'
- name: run_streaming_tests
  type: boolean
  displayName: Run Streaming Tests
  default: true
- name: build_sdk
  type: boolean
  displayName: Build embedded image SDKs
  default: false
- name: cache_sstate
  type: boolean
  displayName: Use sstate cache for embedded builds
  default: true
- name: build_e310_sg1
  type: boolean
  displayName: Build e310_sg1 filesystem image
  default: true
- name: build_e310_sg3
  type: boolean
  displayName: Build e310_sg3 filesystem image
  default: true
- name: build_e320
  type: boolean
  displayName: Build e320 filesystem image
  default: true
- name: build_n3xx
  type: boolean
  displayName: Build n3xx filesystem image
  default: true
- name: build_x4xx
  type: boolean
  displayName: Build x4xx filesystem image
  default: true
- name: fpga_imgs_source
  type: string
  values:
  - 'files.ettus.com (Public)'
  - 'Internal Repo'
  - 'FPGA Pipeline'
  displayName: FPGA Images Source
  default: 'FPGA Pipeline'
  # FPGA Parameters
- name: run_testbenches
  type: boolean
  displayName: Run Testbenches
  default: true
- name: clean_ip_build
  type: boolean
  displayName: Clean IP Build
  default: false
- name: num_ip_jobs
  type: number
  default: 5
  displayName: Number of parallel IP jobs
- name: package_and_publish_images
  type: boolean
  displayName: Package & Publish Images
  default: false
- name: package_access
  type: string
  values:
  - 'Internal'
  - 'files.ettus.com (Public)'
  displayName: Published Package Access
  default: 'Internal'
- name: skip_analyze_changeset
  type: boolean
  displayName: Skip Analyze Changeset
  default: false
- name: build_fpgaimg_x3x0
  type: boolean
  displayName: Build X3x0 FPGA Images
  default: false
- name: build_fpgaimg_n3xx
  type: boolean
  displayName: Build N3xx FPGA Images
  default: false
- name: build_fpgaimg_e31x
  type: boolean
  displayName: Build E31x FPGA Images
  default: false
- name: build_fpgaimg_e32x
  type: boolean
  displayName: Build E32x FPGA Images
  default: false
- name: build_fpgaimg_x410
  type: boolean
  displayName: Build X410 FPGA Images
  default: false
- name: build_fpgaimg_x440
  type: boolean
  displayName: Build X440 FPGA Images
  default: false
# Requested X410 targets
- name: x410_targets_matrix
  type: object
  displayName: X410 Targets
  default:
    X410_UC_200:
      image_core: x410_UC_200_rfnoc_image_core.yml
      image_core_name: usrp_x410_fpga_UC_200
      target_name: X410
      artifact_name: X410_UC_200
      timeout: 720
      max_attempts: 2
    X410_X4_200:
      image_core: x410_X4_200_rfnoc_image_core.yml
      image_core_name: usrp_x410_fpga_X4_200
      target_name: X410
      artifact_name: X410_X4_200
      timeout: 720
      max_attempts: 2
    X410_CG_400:
      image_core: x410_CG_400_rfnoc_image_core.yml
      image_core_name: usrp_x410_fpga_CG_400
      target_name: X410
      artifact_name: X410_CG_400
      timeout: 720
      max_attempts: 2
- name: x440_targets_matrix
  type: object
  displayName: X440 Targets
  default:
    X440_CG_1600:
      image_core: x440_CG_1600_rfnoc_image_core.yml
      image_core_name: usrp_x440_fpga_CG_1600
      target_name: X440
      artifact_name: X440_CG_1600
      timeout: 720
      max_attempts: 2
    X440_CG_400:
      image_core: x440_CG_400_rfnoc_image_core.yml
      image_core_name: usrp_x440_fpga_CG_400
      target_name: X440
      artifact_name: X440_CG_400
      timeout: 720
      max_attempts: 2
    X440_X4_1600:
      image_core: x440_X4_1600_rfnoc_image_core.yml
      image_core_name: usrp_x440_fpga_X4_1600
      target_name: X440
      artifact_name: X440_X4_1600
      timeout: 720
      max_attempts: 2
    X440_X4_400:
      image_core: x440_X4_400_rfnoc_image_core.yml
      image_core_name: usrp_x440_fpga_X4_400
      target_name: X440
      artifact_name: X440_X4_400
      timeout: 720
      max_attempts: 2
    X440_X4_200:
      image_core: x440_X4_200_rfnoc_image_core.yml
      image_core_name: usrp_x440_fpga_X4_200
      target_name: X440
      artifact_name: X440_X4_200
      timeout: 720
      max_attempts: 2


trigger: none

pr:
  branches:
    include:
    - master
    - UHD-*
  paths:
    include:
    - host
    - mpm
    - fpga
    - .ci
    - images/manifest.txt
    exclude:
    - .ci/docker
    - host/docs
    - host/LICENSE
    - host/README.md
  drafts: false

extends:
  template: templates/stages-uhd-pipeline.yml
  parameters:
    build_linux: ${{ parameters.build_linux }}
    build_mac: ${{ parameters.build_mac }}
    build_win: ${{ parameters.build_win }}
    custom_boost_version: ${{ parameters.custom_boost_version }}
    custom_boost_version_url: ${{ parameters.custom_boost_version_url }}
    release_binaries: ${{ parameters.release_binaries }}
    testLength: ${{ parameters.testLength }}
    run_streaming_tests: ${{ parameters.run_streaming_tests }}
    build_sdk: ${{ parameters.build_sdk }}
    cache_sstate: ${{ parameters.cache_sstate }}
    build_e310_sg1: ${{ parameters.build_e310_sg1 }}
    build_e310_sg3: ${{ parameters.build_e310_sg3 }}
    build_e320: ${{ parameters.build_e320 }}
    build_n3xx: ${{ parameters.build_n3xx }}
    build_x4xx: ${{ parameters.build_x4xx }}
    fpga_imgs_source: ${{ parameters.fpga_imgs_source }}
    # FPGA parameters
    run_testbenches: ${{ parameters.run_testbenches }}
    clean_ip_build: ${{ parameters.clean_ip_build }}
    publish_int_files: true
    package_and_publish_images: ${{ parameters.package_and_publish_images }}
    package_access: ${{ parameters.package_access }}
    build_fpgaimg_x3x0: ${{ parameters.build_fpgaimg_x3x0 }}
    build_fpgaimg_n3xx: ${{ parameters.build_fpgaimg_n3xx }}
    build_fpgaimg_e31x: ${{ parameters.build_fpgaimg_e31x }}
    build_fpgaimg_e32x: ${{ parameters.build_fpgaimg_e32x }}
    build_fpgaimg_x410: ${{ parameters.build_fpgaimg_x410 }}
    build_fpgaimg_x440: ${{ parameters.build_fpgaimg_x440 }}
    x410_targets_matrix: ${{ parameters.x410_targets_matrix }}
    x440_targets_matrix: ${{ parameters.x440_targets_matrix }}
